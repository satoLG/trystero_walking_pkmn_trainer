const{floor:e,random:t}=Math,r="Trystero",n=(e,t)=>Array(e).fill().map(t),a="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",o=r=>n(r,(()=>a[e(62*t())])).join(""),s=o(20),i=Promise.all.bind(Promise),c="undefined"!=typeof window,{entries:l,fromEntries:d,keys:f}=Object,p=()=>{},u=e=>Error(`${r}: ${e}`),y=new TextEncoder,m=new TextDecoder,w=e=>y.encode(e),g=e=>m.decode(e),h=(...e)=>e.join("@"),b=JSON.stringify,k=JSON.parse,v={},P="AES-GCM",T={},S=async e=>T[e]||(T[e]=Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1",w(e)))).map((e=>e.toString(36))).join("")),A=async(e,t)=>{const r=crypto.getRandomValues(new Uint8Array(16));return r.join(",")+"$"+(n=await crypto.subtle.encrypt({name:P,iv:r},await e,w(t)),btoa(String.fromCharCode.apply(null,new Uint8Array(n))));var n},D=async(e,t)=>{const[r,n]=t.split("$");return g(await crypto.subtle.decrypt({name:P,iv:new Uint8Array(r.split(","))},await e,(e=>{const t=atob(e);return new Uint8Array(t.length).map(((e,r)=>t.charCodeAt(r))).buffer})(n)))},L="icegatheringstatechange",I=e=>e.replace(/a=ice-options:trickle\s\n/g,"");var $=(e,{rtcConfig:t,rtcPolyfill:r,turnConfig:n})=>{const a=new(r||RTCPeerConnection)({iceServers:E.concat(n||[]),...t}),o={},s=e=>{e.binaryType="arraybuffer",e.bufferedAmountLowThreshold=65535,e.onmessage=e=>o.data?.(e.data),e.onopen=()=>o.connect?.(),e.onclose=()=>o.close?.(),e.onerror=e=>o.error?.(e)},i=async e=>{if(!e.localDescription)throw Error("No local description available");return await Promise.race([new Promise((t=>{const r=()=>{"complete"===e.iceGatheringState&&(e.removeEventListener(L,r),t())};e.addEventListener(L,r),r()})),new Promise((e=>setTimeout(e,5e3)))]),{type:e.localDescription.type,sdp:I(e.localDescription.sdp)}};let c=!1,l=null,d=!1;return e?(l=a.createDataChannel("data"),s(l)):a.ondatachannel=({channel:e})=>{l=e,s(e)},a.onnegotiationneeded=async()=>{try{c=!0,await a.setLocalDescription();const e=await i(a);o.signal?.({type:e.type,sdp:I(e.sdp)})}catch(e){o.error?.(e)}finally{c=!1}},a.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(a.connectionState)&&o.close?.()},a.ontrack=e=>{o.track?.(e.track,e.streams[0]),o.stream?.(e.streams[0])},a.onremovestream=e=>{o.stream?.(e.stream,{removed:!0})},e&&(a.canTrickleIceCandidates||a.onnegotiationneeded()),{created:Date.now(),connection:a,get channel(){return l},get isDead(){return"closed"===a.connectionState},async signal(t){if("open"!==l?.readyState)try{if("offer"===t.type){if((c||"stable"!==a.signalingState)&&(d=!e,d))return;await a.setRemoteDescription(t),await a.setLocalDescription();const r=await i(a),n=I(r.sdp);return o.signal?.({type:r.type,sdp:n}),{type:r.type,sdp:n}}"answer"!==t.type||"have-local-offer"!==a.signalingState&&"have-remote-offer"!==a.signalingState||await a.setRemoteDescription(t)}catch(e){o.error?.(e)}else if(("offer"===t.type||"stable"!==a.signalingState)&&(await a.setRemoteDescription(t),"offer"===t.type)){await a.setLocalDescription();const e=await i(a);return o.signal?.({type:e.type,sdp:e.sdp}),{type:e.type,sdp:e.sdp}}},sendData(e){return l.send(e)},destroy(){l&&l.close(),a.close()},setHandlers(e){return Object.assign(o,e)},offerPromise:e?new Promise((e=>{o.signal=t=>{"offer"===t.type&&e(t)}})):Promise.resolve(),addStream(e){e.getTracks().forEach((t=>a.addTrack(t,e)))},removeStream(e){a.getSenders().filter((t=>e.getTracks().includes(t.track))).forEach((e=>a.removeTrack(e)))},addTrack(e,t){return a.addTrack(e,t)},removeTrack(e){const t=a.getSenders().find((t=>t.track===e));t&&a.removeTrack(t)},async replaceTrack(e,t){const r=a.getSenders().find((t=>t.track===e));r&&await r.replaceTrack(t)}}};const E=[...n(3,((e,t)=>`stun:stun${t||""}.l.google.com:19302`)),"stun:global.stun.twilio.com:3478"].map((e=>({urls:e}))),C=Object.getPrototypeOf(Uint8Array),U=16369,_=255,O="bufferedamountlow",j=e=>"@_"+e;const H={},J={},M={},R={},x={},q={},B={},N={},G=async e=>{if(J[e])return J[e];const t=(await S(e)).slice(0,20);return J[e]=t,M[t]=e,t},z=async(e,t,r)=>e.send(b({action:"announce",info_hash:await G(t),peer_id:s,...r})),K=(e,t,n)=>console.warn(`${r}: torrent tracker ${n?"failure":"warning"} from ${e} - ${t}`),V=(({init:e,subscribe:t,announce:a})=>{const o={};let y,m,v,T=!1;return(L,I,E)=>{const{appId:H}=L;if(o[H]?.[I])return o[H][I];const J={},M={},R=h(r,H,I),x=S(R),q=S(h(R,s)),B=(async(e,t,r)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},w(`${e}:${t}:${r}`)),{name:P},!1,["encrypt","decrypt"]))(L.password||"",H,I),N=e=>async t=>({type:t.type,sdp:await e(B,t.sdp)}),G=N(D),z=N(A),K=()=>$(!0,L),V=(e,t,r)=>{M[t]?M[t]!==e&&e.destroy():(M[t]=e,te(e,t),J[t]?.forEach(((e,t)=>{t!==r&&e.destroy()})),delete J[t])},W=(e,t)=>{M[t]===e&&delete M[t]},F=e=>(m.push(...n(e,K)),i(m.splice(0,e).map((e=>e.offerPromise.then(z).then((t=>({peer:e,offer:t}))))))),Q=(e,t)=>E?.({error:`incorrect password (${L.password}) when decrypting ${t}`,appId:H,peerId:e,roomId:I}),X=e=>async(t,r,n)=>{const[a,o]=await i([x,q]);if(t!==a&&t!==o)return;const{peerId:c,offer:l,answer:d,peer:f}="string"==typeof r?k(r):r;if(c!==s&&!M[c])if(!c||l||d){if(l){const t=J[c]?.[e];if(t&&s>c)return;const r=$(!1,L);let a;r.setHandlers({connect(){return V(r,c,e)},close(){return W(r,c)}});try{a=await G(l)}catch{return void Q(c,"offer")}if(r.isDead)return;const[o,d]=await i([S(h(R,c)),r.signal(a)]);n(o,b({peerId:s,answer:await z(d)}))}else if(d){let t;try{t=await G(d)}catch(e){return void Q(c,"answer")}if(f)f.setHandlers({connect(){return V(f,c,e)},close(){return W(f,c)}}),f.signal(t);else{const r=J[c]?.[e];r&&!r.isDead&&r.signal(t)}}}else{if(J[c]?.[e])return;const[[{peer:t,offer:r}],a]=await i([F(1),S(h(R,c))]);J[c]||=[],J[c][e]=t,setTimeout((()=>((e,t)=>{if(M[e])return;const r=J[e]?.[t];r&&(delete J[e][t],r.destroy())})(c,e)),.9*Y[e]),t.setHandlers({connect(){return V(t,c,e)},close(){return W(t,c)}}),n(a,b({peerId:s,offer:r}))}};if(!L)throw u("requires a config map as the first argument");if(!H&&!L.firebaseApp)throw u("config map is missing appId field");if(!I)throw u("roomId argument required");if(!T){const t=e(L);m=n(20,K),y=Array.isArray(t)?t:[t],T=!0,v=setInterval((()=>m=m.filter((e=>{const t=Date.now()-e.created<57333;return t||e.destroy(),t}))),59052.99)}const Y=y.map((()=>5333)),Z=[],ee=y.map((async(e,r)=>t(await e,await x,await q,X(r),F)));i([x,q]).then((([e,t])=>{const r=async(n,o)=>{const s=await a(n,e,t);"number"==typeof s&&(Y[o]=s),Z[o]=setTimeout((()=>r(n,o)),Y[o])};ee.forEach((async(e,t)=>{await e,r(await y[t],t)}))}));let te=p;return o[H]||={},o[H][I]=((e,t,a)=>{const o={},s={},y={},m={},h={},v={},P={},T={onPeerJoin:p,onPeerLeave:p,onPeerStream:p,onPeerTrack:p},S=(e,t)=>(e?Array.isArray(e)?e:[e]:f(o)).flatMap((e=>{const n=o[e];return n?t(e,n):(console.warn(`${r}: no peer with id ${e} found`),[])})),A=e=>{o[e]&&(delete o[e],delete m[e],delete h[e],T.onPeerLeave(e),t(e))},D=e=>{if(s[e])return y[e];if(!e)throw u("action type argument is required");const t=w(e);if(t.byteLength>12)throw u(`action type string "${e}" (${t.byteLength}b) exceeds byte limit (12). Hint: choose a shorter name.`);const r=new Uint8Array(12);r.set(t);let a=0;return s[e]={onComplete:p,onProgress:p,setOnComplete:t=>s[e]={...s[e],onComplete:t},setOnProgress:t=>s[e]={...s[e],onProgress:t},async send(e,t,s,c){if(s&&"object"!=typeof s)throw u("action meta argument must be an object");const l=typeof e;if("undefined"===l)throw u("action data cannot be undefined");const d="string"!==l,f=e instanceof Blob,p=f||e instanceof ArrayBuffer||e instanceof C;if(s&&!p)throw u("action meta argument can only be used with binary data");const y=p?new Uint8Array(f?await e.arrayBuffer():e):w(d?b(e):e),m=s?w(b(s)):null,g=Math.ceil(y.byteLength/U)+(s?1:0)||1,h=n(g,((e,t)=>{const n=t===g-1,o=s&&0===t,i=new Uint8Array(15+(o?m.byteLength:n?y.byteLength-U*(g-(s?2:1)):U));return i.set(r),i.set([a],12),i.set([n|o<<1|p<<2|d<<3],13),i.set([Math.round((t+1)/g*_)],14),i.set(s?o?m:y.subarray((t-1)*U,t*U):y.subarray(t*U,(t+1)*U),15),i}));return a=a+1&_,i(S(t,(async(e,t)=>{const{channel:r}=t;let n=0;for(;n<g;){const a=h[n];if(r.bufferedAmount>r.bufferedAmountLowThreshold&&await new Promise((e=>{const t=()=>{r.removeEventListener(O,t),e()};r.addEventListener(O,t)})),!o[e])break;t.sendData(a),n++,c?.(a[14]/_,e,s)}})))}},y[e]||=[s[e].send,s[e].setOnComplete,s[e].setOnProgress]},L=(e,t)=>{const n=new Uint8Array(t),a=g(n.subarray(0,12)).replaceAll("\0",""),[o]=n.subarray(12,13),[i]=n.subarray(13,14),[c]=n.subarray(14,15),l=n.subarray(15),d=!!(1&i),f=!!(2&i),p=!!(4&i),u=!!(8&i);if(!s[a])return void console.warn(`${r}: received message with unregistered type (${a})`);m[e]||={},m[e][a]||={};const y=m[e][a][o]||={chunks:[]};if(f?y.meta=k(g(l)):y.chunks.push(l),s[a].onProgress(c/_,e,y.meta),!d)return;const w=new Uint8Array(y.chunks.reduce(((e,t)=>e+t.byteLength),0));if(y.chunks.reduce(((e,t)=>(w.set(t,e),e+t.byteLength)),0),delete m[e][a][o],p)s[a].onComplete(w,e,y.meta);else{const t=g(w);s[a].onComplete(u?k(t):t,e)}},I=async()=>{await G(""),await new Promise((e=>setTimeout(e,99))),l(o).forEach((([e,t])=>{t.destroy(),delete o[e]})),a()},[$,E]=D(j("ping")),[H,J]=D(j("pong")),[M,R]=D(j("signal")),[x,q]=D(j("stream")),[B,N]=D(j("track")),[G,z]=D(j("leave"));return e(((e,t)=>{o[t]||(o[t]=e,e.setHandlers({data:e=>L(t,e),stream(e){T.onPeerStream(e,t,v[t]),delete v[t]},track(e,r){T.onPeerTrack(e,r,t,P[t]),delete P[t]},signal:e=>M(e,t),close:()=>A(t),error:()=>A(t)}),T.onPeerJoin(t),e.drainEarlyData?.((e=>L(t,e))))})),E(((e,t)=>H("",t))),J(((e,t)=>{h[t]?.(),delete h[t]})),R(((e,t)=>o[t]?.signal(e))),q(((e,t)=>v[t]=e)),N(((e,t)=>P[t]=e)),z(((e,t)=>A(t))),c&&addEventListener("beforeunload",I),{makeAction:D,leave:I,async ping(e){if(!e)throw u("ping() must be called with target peer ID");const t=Date.now();return $("",e),await new Promise((t=>h[e]=t)),Date.now()-t},getPeers:()=>d(l(o).map((([e,t])=>[e,t.connection]))),addStream:(e,t,r)=>S(t,(async(t,n)=>{r&&await x(r,t),n.addStream(e)})),removeStream:(e,t)=>S(t,((t,r)=>r.removeStream(e))),addTrack:(e,t,r,n)=>S(r,(async(r,a)=>{n&&await B(n,r),a.addTrack(e,t)})),removeTrack:(e,t,r)=>S(r,((r,n)=>n.removeTrack(e,t))),replaceTrack:(e,t,r,n,a)=>S(n,(async(n,o)=>{a&&await B(a,n),o.replaceTrack(e,t,r)})),onPeerJoin:e=>T.onPeerJoin=e,onPeerLeave:e=>T.onPeerLeave=e,onPeerStream:e=>T.onPeerStream=e,onPeerTrack:e=>T.onPeerTrack=e}})((e=>te=e),(e=>delete M[e]),(()=>{delete o[H][I],Z.forEach(clearTimeout),ee.forEach((async e=>(await e)())),clearInterval(v)}))}})({init(e){return((e,t,r)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||r))(e,Q,3).map((e=>{const t=((e,t)=>{const r={},n=()=>{const a=new WebSocket(e);a.onclose=()=>{v[e]??=3333,setTimeout(n,v[e]),v[e]*=2},a.onmessage=e=>t(e.data),r.socket=a,r.url=a.url,r.ready=new Promise((t=>a.onopen=()=>{t(r),v[e]=3333})),r.send=e=>{1===a.readyState&&a.send(e)}};return n(),r})(e,(e=>{const t=k(e),n=t["failure reason"],a=t["warning message"],{interval:o}=t,s=M[t.info_hash];if(n)K(r,n,!0);else{if(a&&K(r,a),o&&1e3*o>q[r]&&x[r][s]){const e=Math.min(1e3*o,120333);clearInterval(R[r][s]),q[r]=e,R[r][s]=setInterval(x[r][s],e)}B[t.offer_id]||(t.offer||t.answer)&&(B[t.offer_id]=!0,N[r][s]?.(t))}})),{url:r}=t;return H[r]=t,N[r]={},t.ready}))},subscribe(e,t,r,n,a){const{url:s}=e,i=async()=>{const r=d((await a(10)).map((e=>[o(20),e])));N[e.url][t]=a=>{if(a.offer)n(t,{offer:a.offer,peerId:a.peer_id},((r,n)=>z(e,t,{answer:k(n).answer,offer_id:a.offer_id,to_peer_id:a.peer_id})));else if(a.answer){const e=r[a.offer_id];e&&n(t,{answer:a.answer,peerId:a.peer_id,peer:e.peer})}},z(e,t,{numwant:10,offers:l(r).map((([e,{offer:t}])=>({offer_id:e,offer:t})))})};return q[s]=33333,x[s]||={},x[s][t]=i,R[s]||={},R[s][t]=setInterval(i,q[s]),i(),()=>{clearInterval(R[s][t]),delete N[s][t],delete x[s][t]}},announce(e){return q[e.url]}}),W=(F=H,()=>d(l(F).map((([e,t])=>[e,t.socket]))));var F;const Q=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map((e=>"wss://"+e));export{Q as defaultRelayUrls,W as getRelaySockets,V as joinRoom,s as selfId};